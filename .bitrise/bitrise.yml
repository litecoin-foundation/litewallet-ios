---
format_version: '8'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
trigger_map:
- push_branch: develop/*
  workflow: tests-testflight-ipa
- push_branch: release/*
  workflow: tests-testflight-ipa
- pull_request_source_branch: main
  pull_request_target_branch: release/*
  workflow: tests-testflight-ipa
- pull_request_source_branch: feature/*
  pull_request_target_branch: develop
  workflow: tests-testflight-ipa
- pull_request_source_branch: bugfix/*
  pull_request_target_branch: develop
  workflow: tests-only
- pull_request_source_branch: techdebt/*
  pull_request_target_branch: develop
  workflow: tests-testflight-ipa
workflows:
  tests-only:
    steps:
    - authenticate-with-github-oauth@0:
        inputs:
        - access_token: "$GITHUB_OAUTH_PAT_LW_IOS_AGENT"
        - username: "$GITHUB_IOS_AGENT"
    - git-clone@6: {}
    - script@1:
        inputs:
        - content: "#!/usr/bin/env bash\n# fail if any commands fails\nset -e\n# make
            pipelines' return status equal the last command to exit with a non-zero
            status, or zero if all commands exit successfully\nset -o pipefail\n#
            debug log\nset -x\n \n\nfileid=\"164SOelk_Qzshf0sWcr9zdIESaxQA9aCx\"\nfilename=\"GoogleService-Info.plist\"\nwget
            \"https://drive.google.com/u/1/uc?id=${fileid}&export=download\" -O /Users/vagrant/git/loafwallet/${filename}\n\necho
            \"Google Services file arrived\""
        title: GS File Download
    - cache-pull@2: {}
    - cocoapods-install@2.3:
        inputs:
        - verbose: 'true'
    - cache-push@2:
        inputs:
        - cache_paths: "./Pods -> ./Podfile.lock #If Podfile.lock changes, cache ./Pods"
    - xcode-test@4.6:
        inputs:
        - scheme: loafwallet
        - simulator_device: iPhone 11
        - generate_code_coverage_files: 'yes'
        - destination: platform=iOS Simulator,name=iPhone 12 Pro,OS=latest
        - project_path: loafwallet.xcworkspace
        is_always_run: true
        title: Run Tests (iPhone 12 Sim)
    - set-xcode-build-number@1:
        inputs:
        - plist_path: loafwallet/Info.plist
        title: 'Set Build Num: loafwallet'
    - set-xcode-build-number@1:
        title: 'Set Build Num: Today Extension'
        inputs:
        - plist_path: "$TODAY_EXT_PATH/Info.plist"
    - deploy-to-bitrise-io@2.1: {}
    description: Run anytime a push or PR is opened
  tests-testflight-ipa:
    steps:
    - authenticate-with-github-oauth@0:
        inputs:
        - access_token: "$GITHUB_OAUTH_PAT_LW_IOS_AGENT"
        - username: "$GITHUB_IOS_AGENT"
    - git-clone@6: {}
    - cache-pull@2: {}
    - script@1:
        inputs:
        - content: "#!/usr/bin/env bash\n# fail if any commands fails\nset -e\n# make
            pipelines' return status equal the last command to exit with a non-zero
            status, or zero if all commands exit successfully\nset -o pipefail\n#
            debug log\nset -x\n \n\nfileid=\"164SOelk_Qzshf0sWcr9zdIESaxQA9aCx\"\nfilename=\"GoogleService-Info.plist\"\nwget
            \"https://drive.google.com/u/1/uc?id=${fileid}&export=download\" -O /Users/vagrant/git/loafwallet/${filename}\n\necho
            \"Google Services file arrived\""
        title: GS File Download
    - generic-file-storage@0.9:
        title: 'Generic File Storage: Add Env Vars'
    - cocoapods-install@2.3:
        inputs:
        - verbose: 'true'
    - cache-push@2:
        inputs:
        - cache_paths: "./Pods -> ./Podfile.lock #If Podfile.lock changes, cache ./Pods"
    - xcode-test@4.6:
        inputs:
        - scheme: loafwallet
        - simulator_device: iPhone 11
        - generate_code_coverage_files: 'yes'
        - destination: platform=iOS Simulator,name=iPhone 12 Pro,OS=latest
        - project_path: loafwallet.xcworkspace
        is_always_run: true
        title: Run Tests (iPhone 12 Sim)
    - set-xcode-build-number@1:
        title: 'Set Build Num: loafwallet'
        inputs:
        - plist_path: loafwallet/Info.plist
    - set-xcode-build-number@1:
        title: 'Set Build Num: Today Extension'
        inputs:
        - plist_path: "$TODAY_EXT_PATH/Info.plist"
    - xcode-archive@4.7:
        inputs:
        - scheme: loafwallet
        - project_path: loafwallet.xcworkspace
        - configuration: ''
        - automatic_code_signing: api-key
        - register_test_devices: 'yes'
        - min_profile_validity: '1'
        - distribution_method: app-store
        - api_key_path: ''
        - api_key_id: ''
        - certificate_url_list: "$BITRISEIO_CODESIGN_CERT_URL"
        - perform_clean_action: 'yes'
        - passphrase_list: "$CODE_SIGNING_PASSWORD"
        - api_key_issuer_id: ''
    - deploy-to-itunesconnect-application-loader@1.4:
        inputs:
        - connection: apple_id
        - retries: '3'
        - app_password: "$AS_LITECOIN_NET_ASP"
        - itunescon_user: "$AS_LITECOIN_NET_ADMIN_USER"
    - comment-on-github-pull-request@0.11:
        inputs:
        - body: SUCCESSFUL-BUILD-NUMBER-$BITRISE_BUILD_NUMBER
        - personal_access_token: "$GITHUB_OAUTH_PAT_LW_IOS_AGENT"
        title: Pull Request- Successful Build Sent Comment
        is_always_run: false
    - deploy-to-bitrise-io@2.1: {}
    description: Run anytime a push or PR is opened
app:
  envs:
  - opts:
      is_expand: false
    BASE_BRANCH: main
  - PROJECT_PATH: loafwallet.xcworkspace
  - opts:
      is_expand: false
    XCSCHEME: loafwallet
  - opts:
      is_expand: false
    DISTRIBUTION_METHOD: app-store
  - opts:
      is_expand: false
    WORKSPACE_PATH: pod install --repo-update
  - opts:
      is_expand: false
    TEST_SCHEME: loafwalletTests
  - opts:
      is_expand: false
    APPSTORE_API_KEY_ISSUER_ID: 69a6de96-5c8c-47e3-e053-5b8c7c11a4d1
  - opts:
      is_expand: false
    APPSTORE_API_KEY_ID: 2DKA93TCXU
  - GOOGLE_SERVICES_PATH: loafwallet/GoogleService-Info.plist
    opts:
      is_expand: false
  - PARTNER_SERVICES_PATH: loafwallet/partner-keys.plist
    opts:
      is_expand: false
  - opts:
      is_expand: false
    GS_FILE_PATH: https://drive.google.com/file/d/164SOelk_Qzshf0sWcr9zdIESaxQA9aCx/view?usp=sharing
  - opts:
      is_expand: false
    PK_FILE_PATH: https://drive.google.com/file/d/1fL_P67XqIRWr95VOjXfUlwnA-Ew1L9sJ/view?usp=sharing
  - opts:
      is_expand: false
    TODAY_EXT_PATH: TodayExtension
meta:
  bitrise.io:
    stack: osx-xcode-14.0.x